- name: Install base packages
  ansible.builtin.apt:
    name:
      - docker.io
      - nginx
      - wget
      - curl
      - unzip
      - acl
      - python3-pip
      - python3-setuptools
    state: present
    update_cache: yes

- name: Start and enable Docker
  ansible.builtin.service:
    name: docker
    state: started
    enabled: yes

- name: Ensure Python Docker SDK is installed
  ansible.builtin.pip:
    name: docker
    executable: pip3

- name: Add 'vagrant' user to 'docker' group
  ansible.builtin.user:
    name: vagrant
    groups: docker
    append: yes

- name: Install Grafana Alloy
  ansible.builtin.include_tasks: install_alloy.yml

- name: Add 'alloy' user to 'docker' group
  ansible.builtin.user:
    name: alloy
    groups: docker
    append: yes

- name: Prepare Docker log ACLs for Alloy
  block:
    - name: Allow alloy to traverse /var/lib/docker
      ansible.posix.acl:
        path: /var/lib/docker
        entity: alloy
        etype: user
        permissions: rx
        state: present

    - name: Allow alloy to traverse /var/lib/docker/containers
      ansible.posix.acl:
        path: /var/lib/docker/containers
        entity: alloy
        etype: user
        permissions: rx
        state: present

    - name: Find existing container directories
      ansible.builtin.find:
        paths: /var/lib/docker/containers
        file_type: directory
        recurse: no
      register: container_dirs

    - name: Set ACL on existing container directories
      ansible.posix.acl:
        path: "{{ item.path }}"
        entity: alloy
        etype: user
        permissions: rx
        state: present
      loop: "{{ container_dirs.files }}"
      when: container_dirs.files | length > 0

    - name: Set ACL on existing container log files
      ansible.builtin.shell: |
        setfacl -R -m u:alloy:r /var/lib/docker/containers/*/*.log 2>/dev/null || true
      args:
        executable: /bin/bash
      changed_when: false

    - name: Set default ACL for future container directories
      ansible.builtin.command: >
        setfacl -d -m u:alloy:rx /var/lib/docker/containers
      changed_when: false

    - name: Set default ACL for future container log files
      ansible.builtin.command: >
        setfacl -d -m u:alloy:r /var/lib/docker/containers
      changed_when: false

- name: Create ACL maintenance script
  ansible.builtin.copy:
    dest: /usr/local/bin/fix-docker-acl.sh
    mode: '0755'
    content: |
      #!/bin/bash
      setfacl -m u:alloy:rx /var/lib/docker/containers
      setfacl -R -m u:alloy:rx /var/lib/docker/containers/*/ 2>/dev/null || true
      setfacl -R -m u:alloy:r /var/lib/docker/containers/*/*.log 2>/dev/null || true
      setfacl -d -m u:alloy:rx /var/lib/docker/containers
      setfacl -d -m u:alloy:r /var/lib/docker/containers

- name: Create systemd path unit for ACL monitoring
  ansible.builtin.copy:
    dest: /etc/systemd/system/docker-acl-fix.path
    content: |
      [Unit]
      Description=Monitor Docker containers directory for ACL maintenance

      [Path]
      PathModified=/var/lib/docker/containers
      Unit=docker-acl-fix.service

      [Install]
      WantedBy=multi-user.target

- name: Create systemd service for ACL maintenance
  ansible.builtin.copy:
    dest: /etc/systemd/system/docker-acl-fix.service
    content: |
      [Unit]
      Description=Fix ACL for Docker container logs

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/fix-docker-acl.sh
      StandardOutput=journal
      StandardError=journal

- name: Enable ACL monitoring
  ansible.builtin.systemd:
    name: docker-acl-fix.path
    state: started
    enabled: yes
    daemon_reload: yes

- name: Remove default Nginx site link
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: Restart Nginx

- name: Configure Nginx Reverse Proxy
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/sites-available/default
  notify: Restart Nginx

- name: Enable Nginx site by creating symlink
  ansible.builtin.file:
    src: /etc/nginx/sites-available/default
    dest: /etc/nginx/sites-enabled/default
    state: link
    force: yes
  notify: Restart Nginx

- name: Validate nginx config
  ansible.builtin.command: nginx -t
  changed_when: false

- name: Ensure Nginx is enabled and running
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: yes

- name: Run Jaeger HotROD container
  community.docker.docker_container:
    name: hotrod
    image: jaegertracing/example-hotrod:latest
    ports:
      - "8080:8080"
    env:
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://172.17.0.1:4318"
    state: started
    restart_policy: always

- name: Configure Alloy
  ansible.builtin.template:
    src: alloy.config.j2
    dest: /etc/alloy/config.alloy
    owner: alloy
    group: alloy
    mode: '0644'
  notify: Restart Alloy

- name: Ensure Alloy is enabled and running
  ansible.builtin.service:
    name: alloy
    state: started
    enabled: yes
